<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <title>React</title>
</head>
<body>
<div id="root"></div>

<script>

    const api = {
        get(url) {
            switch (url) {
                case '/lots':
                    return new Promise((resolve) => {
                        resolve([
                            {
                                id: 1,
                                name: "apple",
                                description: "Apple description",
                                price: 15
                            },
                            {
                                id: 2,
                                name: "orange",
                                description: "Orange description",
                                price: 33
                            },
                            {
                                id: 3,
                                name: "mango",
                                description: "Mango description",
                                price: 22
                            }
                        ])
                    })
                default:
                    throw new Error('Url not found');
            }
        }
    }


    //##############################
    let state = {
        time: new Date(),
    }
    //##############################

    const stream = {
        subscribe(channel, listener) {
            const match = /price-(\d+)/.exec(channel)
            if (match) {
                setInterval(() => {
                    listener({
                        id: +match[1],
                        price: Math.round(Math.random() * 10 + 30)
                    })
                }, 1400)
            }
        }
    }

    //##############################
    const Container = () => {
        const node = document.createElement('div')
        node.className = "container"
        return node
    }

    const Render = (newDom, realDom) => realDom.append(newDom)
    const Header = (state) => {
        const node = document.createElement('header')
        const container = Container()
        container.append(Logo())
        container.append(Clock(state))
        node.append(container)
        node.className = "header"
        return node
    }

    const Logo = () => {
        const node = document.createElement('img')
        node.className = "logo"
        node.src = "https://st2.depositphotos.com/1496387/8556/v/950/depositphotos_85563812-stock-illustration-food-vector-logo-design-template.jpg"
        return node
    }

    const Clock = ({ time }) => {
        const node = document.createElement('div')
        node.className = "clock"
        node.innerText = time.toLocaleTimeString()
        return node
    }

    const App = ({ state }) => {
        const App = document.createElement('div')
        const container = Container()

        App.className = "app"
        container.append(Lots(state))
        App.append(Header(state))
        App.append(container)

        return App
    }

    const Lots = ({ lots }) => {
        const node = document.createElement('div')

        if (lots === undefined) {
            node.innerHTML = 'Загрузка...'
            node.className = 'loading'
            return node
        }

        let html = '';
        lots.forEach(item => {
            html += `
             <article class="lot">
                <div class="price"><small class="price-small">price: </small>${item.price}</div>
                <h1 class="lot-name">${item.name}</h1>
                <p>${item.description}</p>
            </article>
            `
        })

        node.className = 'lots'
        node.innerHTML = html
        return node
    }


    const renderView = (state) => {
        document.getElementById('root').innerHTML = ''
        Render(
            App({ state }), document.getElementById('root')
        )
    }

    renderView(state)
    //##############################

    api.get('/lots').then((lots) => {
        state = {
            ...state,
            lots
        }

        const onPrice = (data) => {
            state = {
                ...state,
                lots: state.lots.map((lot) => {
                    if (lot.id === data.id) {
                        return {
                            ...lot,
                            price: data.price
                        }
                    }
                    return lot
                })
            }
        }

        lots.forEach((lot) => {
            stream.subscribe(`price-${lot.id}`, onPrice)
        })
    })


    //##############################
    setInterval(() => {
        state = {
            ...state,
            time: new Date()
        }

        renderView(state)
    }, 1000)
    //##############################
</script>

</body>
</html>